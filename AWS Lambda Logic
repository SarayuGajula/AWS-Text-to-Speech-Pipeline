import json
import boto3
import time

# Create AWS clients
polly = boto3.client("polly")
s3 = boto3.client("s3")

# Config
BUCKET_NAME = "s3-audio-archive"

def lambda_handler(event, context):
    try:
        # Parse input
        body = json.loads(event.get("body", "{}"))
        text = body.get("text", "Hi Sarayu")
        voice = body.get("voice", "Matthew")

        # Generate filename
        filename = f"speech_{int(time.time())}.mp3"

        # Call Polly
        response = polly.synthesize_speech(
            Text=text,
            OutputFormat="mp3",
            VoiceId=voice
        )

        audio_stream = response["AudioStream"].read()

        # Upload to S3
        s3.put_object(
            Bucket=BUCKET_NAME,
            Key=filename,
            Body=audio_stream,
            ContentType="audio/mpeg"
        )

        # Generate public S3 URL
        s3_url = f"https://{BUCKET_NAME}.s3.amazonaws.com/{filename}"

        # Return response
        return {
            "statusCode": 200,
            "headers": {
                "Content-Type": "application/json"
            },
            "body": json.dumps({
                "file_url": s3_url
            })
        }

    except Exception as e:
        return {
            "statusCode": 500,
            "body": json.dumps({"error": str(e)})
        }
